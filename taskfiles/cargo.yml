version: "3.0"

set: ['e', 'u', 'pipefail']
shopt: ['globstar']

tasks:
  install-sccache:
    desc: "Install sccache for Rust build caching"
    platforms: [darwin]
    cmds:
      - brew install sccache
    status:
      - command -v sccache &> /dev/null

  clean:
    desc: "Clean Rust build artifacts"
    cmds:
      - cargo clean
    silent: true

  build:timings:
    desc: "Analyze Rust build performance bottlenecks"
    cmds:
      - cargo build --workspace --timings
      - |
        if [[ "$OSTYPE" == "darwin"* ]]; then
          open target/cargo-timings/cargo-timing.html
        elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
          xdg-open target/cargo-timings/cargo-timing.html 2>/dev/null || echo "Open target/cargo-timings/cargo-timing.html in your browser"
        else
          echo "Open target/cargo-timings/cargo-timing.html in your browser"
        fi

  lint:
    desc: "Run Rust linter"
    cmds:
      - cargo clippy --workspace

  format:
    desc: "Format Rust code"
    cmds:
      - cargo fmt --all

  test:
    desc: "Run Rust tests"
    cmds:
      - |
        if command -v cargo-nextest &> /dev/null; then
          cargo nextest run --workspace
        else
          cargo test --workspace
        fi
